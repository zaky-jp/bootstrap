version: 3
vars:
  ENV_DIR: '{{joinPath .CONFIG_DIR "env.d"}}'
  ENV_ARTIFACT_DIR: './env.d'

tasks:
  mkdir:
    # meta
    desc: 'Create zsh/env.d directory'
    summary: 'Create directory $XDG_CONFIG_HOME/zsh/env.d'
    # conditions
    run: once
    # runner
    cmds:
      - task: :private:mkdir
        vars:
          LABEL: '{{.TASK}}'
          TARGET: '{{.ENV_DIR}}'

  install:
    # meta
    desc: 'Install env fragments'
    summary: 'Install .zshenv fragments from local sources'
    # conditions
    deps: [mkdir]
    preconditions:
      - test -d '{{.ENV_DIR}}'
    sources:
      - '{{.ENV_ARTIFACT_DIR}}/*.zsh'
      - exclude: '{{.ENV_ARTIFACT_DIR}}/.*'
    # runner
    cmds:
      - for: sources
        task: :private:cp
        vars:
          SOURCE: '{{.ITEM}}'
          TARGET: '{{.ENV_DIR}}/'
          LABEL: '{{.TASK}}/{{base .ITEM}}'
